package validator_test

import (
	"testing"

	"github.com/libsv/go-bt/v2"
	"github.com/taal/mapi/validator"
)

func TestDefaultValidator(t *testing.T) {

	tx, _ := bt.NewTxFromString("02000000010f117b3f9ea4955d5c592c61838bea10096fc88ac1ad08561a9bcabd715a088200000000494830450221008fd0e0330470ac730b9f6b9baf1791b76859cbc327e2e241f3ebeb96561a719602201e73532eb1312a00833af276d636254b8aa3ecbb445324fb4c481f2a493821fb41feffffff02a0860100000000001976a914b7b88045cc16f442a0c3dcb3dc31ecce8d156e7388ac605c042a010000001976a9147a904b8ae0c2f9d74448993029ad3c040ebdd69a88ac66000000")
	parentTx, _ := bt.NewTxFromString("02000000010000000000000000000000000000000000000000000000000000000000000000ffffffff03520101ffffffff0100f2052a01000000232103b12bda06e5a3e439690bf3996f1d4b81289f4747068a5cbb12786df83ae14c18ac00000000")

	// The transaction will be spending 1 or more inputs which reference UTXOs. To validate this transaction
	// is properly signed, we need to populate a map with the necessary information for the validator to use.

	parentData := make(map[validator.Outpoint]validator.OutpointData)

	for _, in := range tx.Inputs {
		outpoint := validator.Outpoint{
			Txid: in.PreviousTxIDStr(),
			Idx:  in.PreviousTxOutIndex,
		}

		outpointData := validator.OutpointData{
			ScriptPubKey: *parentTx.Outputs[in.PreviousTxOutIndex].LockingScript,
			Satoshis:     int64(parentTx.Outputs[in.PreviousTxOutIndex].Satoshis),
		}

		parentData[outpoint] = outpointData
	}

	defaultValidator := validator.New()

	if err := defaultValidator.ValidateTransaction(tx, parentData); err != nil {
		t.Error(err)
	}
}

func TestDefaultValidatorShouldFail(t *testing.T) {

	tx, _ := bt.NewTxFromString("02000000010f117b3f9ea4955d5c592c61838bea10096fc88ac1ad08561a9bcabd715a088200000000494830450221008fd0e0330470ac730b9f6b9baf1791b76859cbc327e2e241f3ebeb96561a719602201e73532eb1312a00833af276d636254b8aa3ecbb445324fb4c481f2a493821fb41feffffff02a0860100000000001976a914b7b88045cc16f442a0c3dcb3dc31ecce8d156e7388ac605c042a010000001976a9147a904b8ae0c2f9d74448993029ad3c040ebdd69a88ac66000000")
	parentTx, _ := bt.NewTxFromString("02000000010000000000000000000000000000000000000000000000000000000000000000ffffffff03520101ffffffff0100f2052a01000000232103b12bda06e5a3e439690bf3996f1d4b81289f4747068a5cbb12786df83ae14c18ac00000000")

	// The transaction will be spending 1 or more inputs which reference UTXOs. To validate this transaction
	// is properly signed, we need to populate a map with the necessary information for the validator to use.

	parentData := make(map[validator.Outpoint]validator.OutpointData)

	for _, in := range tx.Inputs {
		outpoint := validator.Outpoint{
			Txid: in.PreviousTxIDStr(),
			Idx:  in.PreviousTxOutIndex,
		}

		// In order to make this fail, I will put 0 as the satoshis value...
		outpointData := validator.OutpointData{
			ScriptPubKey: *parentTx.Outputs[in.PreviousTxOutIndex].LockingScript,
			Satoshis:     0,
		}

		parentData[outpoint] = outpointData
	}

	defaultValidator := validator.New()

	err := defaultValidator.ValidateTransaction(tx, parentData)

	if err == nil {
		t.Error("Validation should have returned an error")
	}

	if err != nil {
		expected := "Script execution failed: false stack entry at end of script execution"
		if err.Error() != expected {
			t.Errorf("Expected %s, got %s", expected, err.Error())
		}
	}
}

func TestDefaultValidator2(t *testing.T) {

	tx, _ := bt.NewTxFromString("0100000001a7968c39fe10ae04686061ab99dc6774f0ebbd8679e521e6fc944d919d9d19a1020000006a4730440220318d23e6fd7dd5ace6e8dc1888b363a053552f48ecc166403a1cc65db5e16aca02203a9ad254cb262f50c89487ffd72e8ddd8536c07f4b230d13a2ccd1435898e89b412102dd7dce95e52345704bbb4df4e4cfed1f8eaabf8260d33597670e3d232c491089ffffffff013a040000000000001976a9141754f52fc862c7a6106c964c35db7d92a57fec2488ac00000000")
	parentTx, _ := bt.NewTxFromString("0100000002107436992b7dfbcd55f32a96b120c7fa4dc97fbc7b50533bfae57da2e1dcb61a020000006b483045022100d447675a02f3538a90654b25ed7351109307b6d434fd1276c9f329e09ede4a1a02202b1befbbdbb27c87f092ff665326343116046b0a4e2c08cd4f0ae7dd722cb642412103107feff22788a1fc8357240bf450fd7bca4bd45d5f8bac63818c5a7b67b03876ffffffff92f543f4c675f48a789d6ec2a312d52098bc7eb657edd40412c8364f26fd7ae0030000006a47304402204e26e5f83e19ac59ff688b49218d9a1ddf0ea67abc07fa93f4f793594e266c1e02204611dc82c98038f7f6b70de3788beaa7d0ba1525744c6e806b84de0e53c5f963412103c134c904118b148d32492cd17d1183088f708a3e4a7429f3260ff51b9e72c6ccffffffff040000000000000000fde508006a0372756e01050c63727970746f6669676874734dcd087b22696e223a312c22726566223a5b22366136336261353064643736353566373934323463636262633066363339626365353836613864383334316662336435373832383562393030613561653134355f6f31222c22363061613538613361656332383866656462343764326564333930346133636638613563373237306465626463306238383937393231323061653664633132375f6f31222c22663239393537336139303731346161666633646634616462656335346336646539313335373038343134636266663162393838613262393732373036376661625f6f31222c22336136376365633363313662646238343762393732626565326663316330373137633539656463616537626635663438633931666563636661363335616633335f6f31222c22313465323738633638666635323165303931366164376337313361653461303135366537363336316462643362326233353764666236303238653064636137615f6f31222c22613738663561366437326637383731316536366336323131666262643061306266643135616439316264643030343034393238613966616363363364613664395f6f31222c22346261353933353063656165366133356437366334323665613333326338343339663764343732396365323933623464373366666562656539613030396461365f6f31222c22316162366463653161323764653566613362353335303762626337666339346466616337323062313936326166333535636466623764326239393336373431305f6f31222c22373166626133383633343162393332333830656335626665646333613430626365343364343937346465636463393463343139613934613863653564666332335f6f31222c22363161653132323165646438626431646438336332326461326232616237643131346139313239363439366365336664306562613737333236623638613238335f6f31222c22303265343732323732613937666631643564633532613534343165656561636235303638363333623664333036663065336366356466303664346566653334345f6f31222c22626132636666623632613138336361653366663133633066646436346430666264343735323634623330313735303939393339386235646330376238333538305f6f31222c22343062396534373865333766383733636532386364383162666635323532346631383063623538353837376331656139383636343933383039363363646237385f6f31222c22393135393534386635323035316538356565356665373939373939666631333061316331393133616433646335393737336431313766373133316137353063315f6f31222c22343662656562353434633566373939663536636239323136313366633432656361366432353665656663653863363561366636306630643131646432323664375f6f31222c22643637626635343534643032646166636234333530653635383939643839306130363630653531343432646330633066366637623235366138356431396561635f6f31222c22633263346339373165383562343939633239613861623231343866643332346665313262353530623866346635373635386134363836653031316438666435385f6f31222c22373839316531333932616238303732383865366536393238656164656161346135373737613264353130393233393037646235343361653932663364323430625f6f31225d2c226f7574223a5b2239323732373765303061653463626563626133353337323263666231636164383636366165613938333561383638363365333531656434363334633937636365222c2238366135303037323035666233663563336361613834383161363531356664316537393837333266323565323030316537363261656531653362306662363561225d2c2264656c223a5b5d2c22637265223a5b22314b694c6641377663633643455862505a5368755151326d4a6a6739703832456837225d2c2265786563223a5b7b226f70223a2243414c4c222c2264617461223a5b7b22246a6967223a307d2c22626567696e222c5b313636343132303638393434385d5d7d2c7b226f70223a2243414c4c222c2264617461223a5b7b22246a6967223a307d2c227265736f6c7665222c5b2239333666366133616436313362313936396531366235346264333532303763326366656336376136363239343232353366643437323833363931323030376162222c313636343132303638393538352c305d5d7d2c7b226f70223a2243414c4c222c2264617461223a5b7b22246a6967223a307d2c227265736f6c7665222c5b2237636435313261643436646665623633313734343132313836363836653735396332323666616338643938353230363935336237303230656164363635643163222c313636343132303731333335322c302c2231343730303864393461353936393536336539613333303732303932346362373432323433313466613066616432666461666633656237303131646164353537222c5b302c302c305d5d5d7d2c7b226f70223a2243414c4c222c2264617461223a5b7b22246a6967223a307d2c227265736f6c7665222c5b2236326639343365656566613262373332383533393932653235346435366431323866613266396463316539616630386336323939333132633062343362396133222c313636343132303731343332372c305d5d7d2c7b226f70223a2243414c4c222c2264617461223a5b7b22246a6967223a307d2c227265736f6c7665222c5b2233353338346239383966346562636536366233353430353366633162303731343866363935343634306266643164353237383632663537316231626462613932222c313636343132303732373733392c302c2233363665333534356163353164393732356236306264393662396463393131306139336266643766383234633735356339656664643032656637373536346665222c5b302c302c305d5d5d7d2c7b226f70223a2243414c4c222c2264617461223a5b7b22246a6967223a307d2c2266696e616c697a65222c5b5d5d7d5d7d01000000000000001976a914cd43ba65ce83778ef04b207de14498440f3bd46c88ac44040000000000001976a914cd43ba65ce83778ef04b207de14498440f3bd46c88aca31b0100000000001976a9144f7d6a485e09770f947c0ba38d15050a5a80b6fa88ac00000000")

	// The transaction will be spending 1 or more inputs which reference UTXOs. To validate this transaction
	// is properly signed, we need to populate a map with the necessary information for the validator to use.

	parentData := make(map[validator.Outpoint]validator.OutpointData)

	for _, in := range tx.Inputs {
		outpoint := validator.Outpoint{
			Txid: in.PreviousTxIDStr(),
			Idx:  in.PreviousTxOutIndex,
		}

		outpointData := validator.OutpointData{
			ScriptPubKey: *parentTx.Outputs[in.PreviousTxOutIndex].LockingScript,
			Satoshis:     int64(parentTx.Outputs[in.PreviousTxOutIndex].Satoshis),
		}

		parentData[outpoint] = outpointData
	}

	defaultValidator := validator.New()
	if err := defaultValidator.ValidateTransaction(tx, parentData); err != nil {
		t.Error(err)
	}
}
